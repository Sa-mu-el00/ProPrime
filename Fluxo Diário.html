<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotina R√≠gida - Fluxo Di√°rio ADAPTATIVO V2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="./utils.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Configura√ß√£o de Est√©tica (Dark Mode Otimizado - Baseado no Modelo) */
        :root {
            --color-primary: #BB86FC; /* Principal - A√ß√µes */
            --color-secondary: #03DAC6; /* Estudo/Foco */
            --color-background: #121212;
            --color-surface: #1E1E1E;
            --color-text: #E0E0E0;
            --color-accent: #FFD700; /* Descanso */
            --color-meta: #79c0ff; /* L√≥gica/Metacogni√ß√£o */
            --color-log: #FF5722; /* Fim de Ciclo/Sa√≠da */
            --color-danger: #cf6679; /* Retrocesso */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
        }
        .container {
            width: 95%;
            max-width: 800px;
            margin: 20px auto;
            background-color: var(--color-surface);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(187, 134, 252, 0.1);
        }
        .step-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .step-number {
            font-weight: bold;
            color: var(--color-primary);
            margin-right: 15px;
            min-width: 25px;
        }
        .step-name {
            flex-grow: 1;
        }
        .current {
            background-color: #333;
            border-left: 5px solid var(--color-secondary);
        }
        .completed {
            opacity: 0.5;
            background-color: #0A0A0A;
            border-left: 5px solid var(--color-primary);
        }
        .action-button {
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 700;
            transition: background-color 0.2s;
        }
        .main-button { background-color: var(--color-secondary); color: var(--color-background); }
        .main-button:hover { background-color: #00A693; }
        .undo-button { background-color: var(--color-danger); color: var(--color-text); }
        .undo-button:hover { background-color: #A05263; }

    </style>
</head>
<body>
    <div class="container">
        <a href="NEXUS.html" class="bg-gray-700 text-white px-3 py-1 rounded-md text-sm mb-4 inline-flex items-center hover:bg-gray-600 transition-colors">
            <span data-lucide="arrow-left" class="w-4 h-4 mr-2"></span>
            Voltar ao Nexus
        </a>
        
        <h1 class="text-3xl font-bold mb-6 text-center text-white">FLUXO DI√ÅRIO ADAPTATIVO</h1>
        <p id="critical-info" class="text-sm mb-4 text-center text-red-400"></p>

        <div id="cycle-display">
            </div>

        <div class="flex justify-between mt-8">
            <button onclick="undoStep()" class="action-button undo-button flex items-center">
                <span data-lucide="rotate-ccw" class="w-5 h-5 mr-2"></span>
                VOLTAR (UNDO)
            </button>
            <button id="advance-button" onclick="advanceStep()" class="action-button main-button flex items-center">
                <span data-lucide="check-circle" class="w-5 h-5 mr-2"></span>
                AVAN√áAR PASSO
            </button>
        </div>
    </div>
    
    <div id="custom-toast"></div>

    <script type="module">
        import { saveLocalData, loadLocalData, showToast, getCriticalCategory } from './utils.js';
        
        const DEFAULT_ROUTINE = [
            { id: 1, name: 'Despertar (Preparo Cognitivo)', link: '', icon: 'sunrise' },
            { id: 2, name: 'Protocolo Matinal (Leitura/Not√≠cias)', link: '', icon: 'rss' },
            { id: 3, name: 'Reflex√£o Di√°ria', link: 'Reflex√£o Di√°ria.html', icon: 'message-square-text' },
            { id: 4, name: 'Sess√£o Anki 1', link: 'anki.html', icon: 'layout-grid' },
            { id: 5, name: 'Estudo Sess√£o 1 (Foco M√°ximo)', link: 'Ciclo de Estudos Autom√°tico.html', icon: 'book-open-text' },
            { id: 6, name: 'Pausa Almo√ßo/Descanso', link: 'Descanso.html', icon: 'coffee' },
            { id: 7, name: 'Estudo Sess√£o 2 (Profici√™ncia)', link: 'Ciclo de estudos autom√°tica de ingl√™s.html?disc=Ingl√™s', icon: 'globe' },
            { id: 8, name: 'An√°lise de Fadiga (TDP)', link: 'Fadiga 3.html', icon: 'eye' },
            { id: 9, name: 'Estudo Sess√£o 3 (Revis√£o)', link: 'Ciclo de Estudos Autom√°tico.html', icon: 'bookmark' },
            { id: 10, name: 'Rotina Noturna (Reconex√£o)', link: '', icon: 'sunset' },
            { id: 11, name: 'Dormir', link: '', icon: 'moon' },
        ];
        
        let DAILY_ROUTINE = [];
        let currentStepIndex = 0;
        const cycleDisplay = document.getElementById('cycle-display');

        // --- 1. FUN√á√ÉO DE ADAPTA√á√ÉO DO FLUXO (O CORE DO REQUISITO) ---
        function generateAdaptiveRoutine() {
            const criticalCategory = getCriticalCategory();
            const routine = [...DEFAULT_ROUTINE];

            document.getElementById('critical-info').innerHTML = `**CALIBRA√á√ÉO ATIVA:** Categoria Cr√≠tica da √öltima Reflex√£o: <span class="font-bold">${criticalCategory.toUpperCase()}</span>. Rotina adaptada.`;

            // Gateway 1: Protocolo de Vigil√¢ncia Injetado (Foco ou T√©dio)
            if (criticalCategory === 'Foco') {
                // Injeta antes da Sess√£o Anki
                routine.splice(3, 0, { 
                    id: 301, 
                    name: 'GATEWAY: VIGIL√ÇNCIA SUSTENTADA', 
                    link: 'Mem√≥ria num√©rica.html', 
                    icon: 'brain-circuit',
                    isDynamic: true
                }); 
            } else if (criticalCategory === 'Fadiga') {
                 // Gateway 2: Protocolo Parassimp√°tico Injetado (Descanso)
                // Injeta logo ap√≥s o despertar, antes do estudo principal.
                routine.splice(1, 0, { 
                    id: 101, 
                    name: 'GATEWAY: PROTOCOLO PARASSIMP√ÅTICO', 
                    link: 'Descanso.html', 
                    icon: 'relax',
                    isDynamic: true
                }); 
            }
            
            // Re-indexa os IDs ap√≥s a inje√ß√£o (apenas para exibi√ß√£o)
            return routine.map((step, index) => ({
                ...step,
                id: index + 1 // Novos IDs sequenciais
            }));
        }
        
        // --- 2. GEST√ÉO DE ESTADO (LOCAL STORAGE) ---
        function saveCycleState() {
            saveLocalData('dailyFlowState', { index: currentStepIndex, date: new Date().toISOString().split('T')[0] });
        }

        function loadCycleState() {
            const savedState = loadLocalData('dailyFlowState', { index: 0, date: new Date().toISOString().split('T')[0] });
            const today = new Date().toISOString().split('T')[0];
            
            // Se for um novo dia, reseta o ciclo.
            if (savedState.date !== today) {
                currentStepIndex = 0;
                showToast("Novo dia, novo ciclo. Rotina recalculada.", false);
            } else {
                currentStepIndex = savedState.index;
            }
        }

        // --- 3. RENDERIZA√á√ÉO ---
        function renderCycle() {
            cycleDisplay.innerHTML = '';
            
            DAILY_ROUTINE.forEach((step, index) => {
                const isCurrent = index === currentStepIndex;
                const isCompleted = index < currentStepIndex;
                
                const stepEl = document.createElement('div');
                stepEl.className = `step-item ${isCurrent ? 'current' : ''} ${isCompleted ? 'completed' : ''}`;
                
                let html = `<span class="step-number">${index + 1}.</span>`;
                html += `<span class="step-name">${step.name}</span>`;
                
                if (step.link) {
                    html += `<a href="${step.link}" class="text-sm font-semibold ml-4 px-3 py-1 rounded-md ${isCurrent ? 'bg-primary text-background' : 'bg-gray-700 text-white'}" target="_self">
                                <span data-lucide="${step.icon}" class="w-4 h-4 mr-1 inline-block align-middle"></span>
                                INICIAR
                            </a>`;
                }

                stepEl.innerHTML = html;
                cycleDisplay.appendChild(stepEl);
            });
            
            // Re-renderiza os √≠cones Lucide
            lucide.createIcons();
            saveCycleState(); // Salva o estado ap√≥s renderizar
        }

        // --- 4. FUN√á√ïES DE FLUXO ---
        window.advanceStep = function() {
            if (currentStepIndex < DAILY_ROUTINE.length - 1) {
                currentStepIndex++;
                showToast(`Passo ${currentStepIndex + 1} de ${DAILY_ROUTINE.length} ATIVADO.`, false);
                renderCycle();
            } else {
                showToast("üéâ Fim do ciclo di√°rio. Indo para o Passo: Dormir.", false);
                // Permanece no √∫ltimo passo (Dormir)
                renderCycle(); 
            }
        }

        /**
         * FUN√á√ÉO DE RETROCESSO (UNDO) (REQUISITO CUMPRIDO)
         */
        window.undoStep = function() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                showToast(`¬´ UNDO: Retornou ao passo ${currentStepIndex + 1}.`, true);
                renderCycle();
            } else {
                showToast("J√° est√° no primeiro passo (1. Despertar).", true);
            }
        }

        // --- 5. INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            DAILY_ROUTINE = generateAdaptiveRoutine();
            loadCycleState();
            renderCycle();
        });

    </script>
</body>
</html>